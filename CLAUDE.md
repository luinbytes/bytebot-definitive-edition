# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

**IMPORTANT: Update this file when making significant changes. Add to "Recent Changes" with dates.**

---

## Quick Reference

### Development Commands
```bash
npm install              # Install dependencies
npm start                # Start the bot
npm run dev              # Run tests + start bot
npm test                 # Run test suite
npm run db:generate      # Generate Drizzle migrations
npm run db:push          # Push schema changes to database

# Command deployment (CLI flags)
npm start -- --deploy         # Deploy to GUILD_ID (instant)
npm start -- --deploy-all     # Deploy to all guilds (instant)
npm start -- --deploy-global  # Deploy globally (1hr propagation)
```

### Environment Setup
Required `.env` variables: `DISCORD_TOKEN`, `CLIENT_ID`, `GUILD_ID`, `DATABASE_URL` (optional, defaults to sqlite.db)

---

## Project Overview

Discord bot (Discord.js v14) with neon purple branding (#8A2BE2), slash commands, RBAC, BytePods (ephemeral voice channels), SQLite+Drizzle, and War Thunder integration.

**Stack:** discord.js v14.25.1, drizzle-orm v0.45.1, better-sqlite3, axios, chalk, glob, Jest

---

## Architecture

### Entry Point (src/index.js, lines 1-86)
1. Create Client (Intents: Guilds, GuildMembers, GuildMessages, MessageContent, GuildVoiceStates, GuildMessageReactions)
2. Init `client.commands` and `client.cooldowns` Collections
3. Global error handlers (unhandledRejection, uncaughtException)
4. Run DB migrations ‚Üí Load handlers ‚Üí Login

### Database (src/database/)

**schema.js - 26 tables:**
| Table | Key Fields | Notes |
|-------|------------|-------|
| guilds | id, prefix, logChannel, welcomeChannel, welcomeMessage, welcomeEnabled, welcomeUseEmbed, voiceHubChannelId, voiceHubCategoryId, mediaArchiveChannelId | Guild config, BytePod, welcome messages, media archive |
| users | id, guildId, commandsRun, lastSeen, wtNickname | WT account binding |
| moderationLogs | id, guildId, targetId, executorId, action, reason, timestamp | Actions: BAN/KICK/CLEAR/WARN |
| commandPermissions | id, guildId, commandName, roleId | RBAC overrides |
| bytepods | channelId(PK), guildId, ownerId, originalOwnerId, ownerLeftAt, reclaimRequestPending, createdAt | Ephemeral VC tracking |
| bytepodAutoWhitelist | id, userId, targetUserId, guildId | Auto-allow presets |
| bytepodUserSettings | userId(PK), autoLock | Per-user prefs |
| bytepodActiveSessions | id, podId, userId, guildId, startTime | Restart resilience |
| bytepodVoiceStats | id, userId, guildId, totalSeconds, sessionCount | Aggregate stats |
| bytepodTemplates | id, userId, name, userLimit, autoLock, whitelistUserIds(JSON) | Saved configs |
| birthdays | id, userId, guildId, month, day, createdAt | No year (privacy), unique(userId,guildId) |
| birthdayConfig | guildId(PK), channelId, roleId, enabled, lastCheck | Guild celebration config |
| bookmarks | id, userId, guildId, channelId, messageId, content, authorId, attachmentUrls, savedAt, messageDeleted | 100 limit, 4000 char |
| mediaGalleryConfig | id, guildId, channelId, enabled, autoCapture, fileTypes, maxFileSizeMB, autoTagChannel, whitelistRoleIds, createdBy, createdAt, updatedAt | Per-channel auto-capture config, unique(guildId,channelId) |
| mediaItems | id, userId, guildId, channelId, messageId, mediaUrl, fileName, fileType, mimeType, fileSize, width, height, duration, description, contentPreview, authorId, captureMethod, savedAt, messageDeleted, urlExpired | 500/user limit, rich metadata |
| mediaTags | id, mediaId, tag, autoGenerated, createdAt | Tag system, unique(mediaId,tag) |
| autoResponses | id, guildId, trigger, response, channelId, creatorId, enabled, cooldown, matchType, requireRoleId, useCount, createdAt, lastUsed | 50/guild, 5-min cache |
| suggestionConfig | guildId(PK), channelId, reviewRoleId, enabled, allowAnonymous | Review role null=Admin only |
| suggestions | id, guildId, userId, content, messageId, channelId, status, upvotes, downvotes, reviewedBy, reviewedAt, reviewReason, createdAt, anonymous | Status: pending/approved/denied/implemented |
| activityStreaks | id, userId, guildId, currentStreak, longestStreak, lastActivityDate, totalActiveDays, freezesAvailable, lastFreezeReset | unique(userId,guildId), monthly freeze reset |
| activityAchievements | id, userId, guildId, achievementId, points, notified, earnedAt | unique(userId,guildId,achievementId), auto-tracked + manual awards |
| activityLogs | id, userId, guildId, activityDate, messageCount, voiceMinutes, commandsRun, bytepodsCreated, channelJoins, reactionsAdded, activeHours, updatedAt | unique(userId,guildId,activityDate), comprehensive daily tracking |
| achievementDefinitions | id(PK), title, description, emoji, category, rarity, points, criteria(JSON), grantRole, seasonal, seasonalEvent, startDate, endDate, createdAt | 82 core achievements with seasonal support |
| achievementRoleConfig | guildId(PK), enabled, rolePrefix, useRarityColors, cleanupOrphaned, notifyOnEarn, createdAt, updatedAt | Per-guild role reward settings |
| achievementRoles | id, guildId, achievementId, roleId, createdAt | Tracks which roles map to achievements, unique(guildId,achievementId) |
| customAchievements | id, guildId, achievementId, title, description, emoji, category, rarity, points, criteria(JSON), grantRole, enabled, createdBy, createdAt | Guild-specific custom achievements |

**index.js:** better-sqlite3 ‚Üí Drizzle wrapper. `runMigrations()` runs `validateAndFixSchema()` first (auto-heals), then Drizzle migrations.

### Handlers (src/handlers/)
- **commandHandler.js (7-48):** Globs `src/commands/**/*.js`, validates data+execute, extracts category from folder, stores in `client.commands`, registers to Discord
- **eventHandler.js (6-23):** Globs `src/events/**/*.js`, binds via `client.once()` or `client.on()` based on `event.once`

---

## Critical Systems

### 1. Command Security Pipeline (src/events/interactionCreate.js:49-174)
```
1. DM Validation (61-69) ‚Üí data.dm_permission !== false
2. Bot Permission Check (72-85) ‚Üí SendMessages + EmbedLinks
3. Developer-Only Gate (88-93) ‚Üí command.devOnly checks config.developers
4. RBAC (96-106) ‚Üí checkUserPermissions(), DB overrides > code perms
5. Cooldown (109-129) ‚Üí Per-command/user, default 3s
6. DB Tracking (134-149) ‚Üí Increment commandsRun, update lastSeen
7. Auto-Defer (154-157) ‚Üí If command.longRunning, deferReply()
8. Execute (160-173) ‚Üí try/catch with error embeds
```
**Key:** This is the ONLY slash command entry point. All security happens here.

### 2. BytePod System (src/events/voiceStateUpdate.js)

**Join Hub (29-112):**
```
Join hub ‚Üí Fetch voiceHubChannelId ‚Üí checkBotPermissions(ManageChannels,MoveMembers,Connect)
  ‚Üí If missing: Kick user, DM user+owner
  ‚Üí Fetch autoLock setting ‚Üí Create "{username}'s Pod"
    ‚Üí Overwrites: @everyone(View=true,Connect=autoLock), Owner(Connect+ManageChannels+MoveMembers)
    ‚Üí Apply auto-whitelist ‚Üí Move user ‚Üí Insert DB ‚Üí Send control panel
```

**Leave Pod (114-136):**
```
Leave ‚Üí Check bytepods table
  ‚Üí members.size === 0: Delete channel + DB (handle error 10003)
  ‚Üí OWNER leaves (others remain): Set ownerLeftAt ‚Üí 5-min timeout ‚Üí Transfer to first member
```

**Ownership Transfer:**
- Owner leaves: `pendingOwnershipTransfers` Map tracks timeout
- After 5 min: New owner gets perms, channel renamed, notification sent
- Owner returns during grace: Cancel timeout, clear ownerLeftAt
- Original owner returns after transfer: "Request Ownership Back" button ‚Üí Accept/Deny flow

**Control Panel (src/commands/utility/bytepod.js:174-393):**
- Ownership check (184-192): Must be owner OR have EXPLICIT ManageChannels allow overwrite (not server Admin)
- Components: Lock/Unlock, Whitelist(batch), Co-Owner(owner only), Rename modal, Limit modal(0-99), Kick
- Panel updates (198-209): customId embeds panel message ID for targeted updates

**CRITICAL:** Co-owner check is STRICT - requires explicit channel permission overwrite, prevents server mod bypass.

### 3. RBAC Permission System (src/utils/permissions.js:15-49)
```javascript
checkUserPermissions():
1. Query commandPermissions for (guildId, commandName)
2. If overrides exist: User needs ANY allowed role OR Administrator
3. If no overrides: Check command.permissions array
4. Return { allowed: true/false, error? }
```
- `/perm add/remove [cmd] [role]` - Manage overrides
- `/perm reset [cmd]` - Clear overrides, revert to code
- `/perm list` - View all overrides

**Key:** Once DB overrides exist, code-defined permissions are IGNORED.

### 4. Achievement System (src/services/activityStreakService.js)

**Architecture:** 87 core achievements + 16 seasonal + guild custom achievements with automatic tracking, role rewards, and seasonal events.

**Achievement Categories (9 total):**
```
streak      ‚Üí Consecutive day milestones (3-1000 days)
dedication  ‚Üí Total active days (30-1500 days)
social      ‚Üí Messages, reactions, BytePods
voice       ‚Üí Voice hours milestones (10-5000 hrs)
explorer    ‚Üí Channel joins, active hours
special     ‚Üí Unique achievements (first streak, freeze master, night owl, etc.)
combo       ‚Üí Multi-criteria (social butterfly, triple threat)
meta        ‚Üí Achievement collecting (25, 50, 75+ achievements)
seasonal    ‚Üí Limited-time events (Halloween, Christmas, Summer, etc.)
```

**Rarity Tiers (6 levels):**
- common (‚ö™ 10-25 pts) ‚Üí uncommon (üü¢ 50 pts) ‚Üí rare (üîµ 75-100 pts)
- epic (üü£ 150-250 pts) ‚Üí legendary (üü† 500 pts) ‚Üí mythic (üî¥ 1000 pts)

**Core Components:**

1. **AchievementManager Class** (`activityStreakService.js:20-286`)
   - **Auto-initialization:** Automatically seeds 98 achievements on first run if database is empty
   - Loads definitions from DB with 1-hour cache
   - Methods: `loadDefinitions()`, `seedAchievements()`, `getById()`, `getByCategory()`, `getByRarity()`, `getAllGrantingRoles()`
   - Seasonal validation: `isSeasonalActive()`, `canAward()`, `getActiveSeasonalAchievements()`
   - Custom achievements: `getCustomAchievements(guildId)`

2. **Activity Tracking** (8 metrics tracked daily in `activityLogs`):
   - Messages, voice minutes, commands run
   - BytePods created, channel joins, reactions added
   - Active hours (hourly tracking)
   - Tracked via: `messageCreate.js`, `voiceStateUpdate.js`, `interactionCreate.js`, `messageReactionAdd.js`

3. **Achievement Checking** (6 check methods):
   - `checkStreakAchievements()` - Exact streak milestone matches
   - `checkTotalDaysAchievements()` - Total active days thresholds
   - `checkCumulativeAchievements()` - Messages, voice, commands, BytePods
   - `checkSpecialAchievements()` - Unique conditions (night owl, weekend warrior)
   - `checkComboAchievements()` - Multi-criteria combinations
   - `checkMetaAchievements()` - Achievement count milestones

4. **Award Flow:**
   ```
   Activity occurs ‚Üí Tracking method called ‚Üí checkAllAchievements() runs
     ‚Üí calculateEligibleAchievements() ‚Üí Seasonal validation ‚Üí awardAchievement()
       ‚Üí Insert DB ‚Üí Send DM notification ‚Üí Grant role reward (if enabled)
         ‚Üí Invalidate cache
   ```

5. **Startup Processing:**
   - **Auto-seeding:** First run detects empty database ‚Üí seeds 103 achievements (87 core + 16 seasonal)
   - **Missed achievements:** Every startup runs `processMissedAchievements()` ‚Üí checks all users ‚Üí awards missing achievements
   - **Bot downtime recovery:** Awards achievements earned while bot was offline automatically on restart
   - **Daily check:** Midnight UTC ‚Üí runs streak check + achievement processing for all users

5. **Role Reward System** (`activityStreakService.js:1458-1615`):
   - Dynamic role creation with achievement name
   - Rarity-based colors (or brand purple #8A2BE2)
   - Configurable prefix (default: üèÜ)
   - Automatic cleanup of orphaned roles (0 members)
   - Scheduled cleanup runs daily at midnight UTC

6. **Seasonal Achievements:**
   - Year-agnostic date matching (Oct 1-31 = Halloween every year)
   - Handles year-spanning events (Dec 26 - Jan 5)
   - Validation before awarding prevents off-season awards
   - 16 seasonal achievements defined in `scripts/seed-seasonal-events.js`

7. **Custom Achievements:**
   - Per-guild custom achievements via modal builder
   - 5-field modal: title, description, emoji, rarity, points
   - Auto-generated ID: `custom_{guildId}_{sanitized_title}`
   - Manual award only (no auto-tracking)
   - Stored in `customAchievements` table

**Commands:**
- `/achievement setup/view/cleanup/list_roles` - Admin config (Administrator required)
- `/achievement create` - Modal builder for custom achievements
- `/achievement award [user] [achievement]` - Manual award with autocomplete
- `/streak view/leaderboard/achievements/progress` - User commands
- Achievements shown in `/userinfo` context menu (top 6 + total count)

**Key Files:**
- **activityStreakService.js (1700+ lines):** Core service, AchievementManager, tracking, awarding
- **achievementUtils.js (240 lines):** Shared helpers (emojis, tiers, progress bars, milestones)
- **achievement.js (525 lines):** Admin command with 6 subcommands + autocomplete
- **streak.js (700 lines):** User command with 4 subcommands + pagination
- **seed-achievements.js:** 82 core achievement definitions
- **seed-seasonal-events.js:** 16 seasonal achievements
- **backfill-achievements.js:** Retroactive award script for historical data

**Achievement Progression Example:**
```
User joins ‚Üí Creates first streak (special_first_streak +10pts)
  ‚Üí 3 days active (streak_3 +25pts)
    ‚Üí 7 days active (streak_7 +50pts)
      ‚Üí 30 days active (streak_30 +100pts) + role reward granted
        ‚Üí 365 days active (streak_365 +500pts, legendary rarity)
```

**Gotchas:**
- Achievement cache is 1-hour, invalidate after creating custom achievements
- Seasonal achievements checked on award, not on earn (prevents backdating)
- Custom achievements must have unique titles within a guild
- Role rewards require bot to have ManageRoles permission
- DM notifications fail silently if user has DMs disabled (logged)

---

## Commands

### Administration (src/commands/administration/)
| Command | Description |
|---------|-------------|
| config.js | Manage log channels, view config (Admin) |
| perm.js | RBAC management with autocomplete (Admin) |
| welcome.js (~420 lines) | `/welcome setup/message/toggle/embed/variables/test/view` - New member welcome messages. 18 variables: user mentions, server info, join dates (Discord timestamps), account age, member number (1st, 2nd, 3rd). Embed/plain text modes. `/variables` shows full reference guide. Requires ManageGuild |
| autorespond.js (~450 lines) | `/autorespond add/remove/list/toggle/edit` - Keyword responses. Match types: exact/contains/wildcard/regex(dev-only). Variables: {user}{server}{channel}{username}. Requires ManageGuild |
| suggestion.js (~650 lines) | `/suggestion setup/approve/deny/implement/view/list/leaderboard` - Community suggestions. DM notifications, auto-embed updates |
| achievement.js (~525 lines) | `/achievement setup/view/cleanup/list_roles/create/award` - Achievement system admin. Role reward config, custom achievement builder (modal), manual awards with autocomplete. Requires Administrator |

### Developer (src/commands/developer/) - All devOnly
| Command | Description |
|---------|-------------|
| guilds.js | List all guilds |
| manageguilds.js | List/leave guilds via select menu |
| deploy.js | `/deploy <scope>` - Force command sync. Guild(instant) or Global(1hr). Detects duplicates. 10s cooldown |
| unregister.js | `/unregister <scope>` - Clear command registrations (Global/Guild/Both). Fixes duplicates. 10s cooldown |

### Fun (src/commands/fun/)
8ball.js (20 responses), coinflip.js, joke.js (official-joke-api), roll.js (2-100 sides)

### Games (src/commands/games/)
| Command | Description |
|---------|-------------|
| warthunder.js | `/warthunder bind/stats` - ThunderInsights API, aggregates all modes, calculates K/D+winRate |

### Moderation (src/commands/moderation/)
| Command | Description |
|---------|-------------|
| audit.js | `/audit user/recent/by` - Moderation log viewer with filters |
| ban.js, kick.js | Ban/kick + log to DB |
| clear.js | Bulk delete 1-100 messages |
| warn.js, unwarn.js, warnings.js | Warning system with DM + DB logging |
| lock.js, unlock.js | Deny/restore SendMessages for @everyone |

### Utility (src/commands/utility/)
| Command | Description |
|---------|-------------|
| help.js | Command browser with categories |
| ping.js | Roundtrip + WS heartbeat |
| serverinfo.js, userinfo.js | Guild/user stats |
| stats.js | `/stats server` - Members, channels, bot activity, top voice users |
| suggest.js (~140 lines) | `/suggest <idea> [anonymous]` - Submit to configured channel, üëç/üëé reactions, 60s cooldown |
| birthday.js (~450 lines) | `/birthday set/remove/view/upcoming/setup/role` - Privacy-focused (no year), leap year handling, 24hr role |
| bookmark.js (~420 lines) | `/bookmark list/search/view/delete/clear` - Pagination, jump links, attachment caching |
| media.js (~680 lines) | `/media setup/list/delete/search/view/tag/describe` - Full media gallery with auto-capture and manual saves. Rich metadata, tag system, full-text search, detailed views. Setup requires ManageChannels, 500-item limit |
| bytepod.js (~600 lines) | `/bytepod setup/panel/preset/stats/leaderboard/template` - Full pod management, `handleInteraction()` routes all components |
| streak.js (~700 lines) | `/streak view/leaderboard/achievements/progress` - Comprehensive activity tracking. View streaks with rarity/points, 5 leaderboard types (current/longest/achievements/points/rare), achievement browser with filters & pagination (category/rarity/earned status), progress tracking with visual bars for milestones. Auto-tracks 8 metrics, 82+ achievements, monthly freeze system |

### Context Menus (src/commands/context-menus/)

**Message:**
- bookmark.js - Right-click ‚Üí "Bookmark Message", DM-enabled, 3s cooldown
- save-media.js - Right-click ‚Üí "Save Media", Guild-only, 3s cooldown, saves all attachments to gallery

**User:**
| Menu | Description |
|------|-------------|
| avatar.js | Server+user avatar, PNG/WebP/GIF links, DM-enabled |
| userinfo.js | Full user info, badges, bot stats, DM-enabled |
| copyid.js | Code block format, DM-enabled |
| permissions.js | Channel perms categorized (Dangerous/Important/Other), Guild-only |
| activity.js | Bot usage, voice stats, current voice status, Guild-only |
| modactions.js (~350 lines) | Warn/Kick/Ban/History buttons, modal input, hierarchy validation, DM notifications, Guild-only |

---

## Utilities (src/utils/)

| Module | Purpose |
|--------|---------|
| embeds.js | Branding (#8A2BE2). Methods: base, success, error, warn, brand, info. **NEVER use EmbedBuilder directly** |
| logger.js | Colored console: info(blue), success(green), warn(yellow), error(red), debug(magenta) |
| permissions.js | `checkUserPermissions()` - RBAC logic |
| permissionCheck.js | `checkBotPermissions()` - BytePod validator (ManageChannels,MoveMembers,Connect) |
| wtService.js | Singleton for ThunderInsights: `searchPlayer()`, `getPlayerStats()` |
| bookmarkUtil.js | `saveBookmark/getBookmarks/deleteBookmark/deleteAllBookmarks/markDeleted/searchBookmarks` - 100 limit, duplicate prevention |
| mediaUtil.js | `saveMedia/getMedia/searchMedia/getMediaById/deleteMedia/addTag/removeTag/updateDescription/getMediaCount/markDeleted/getOrCreateArchiveChannel/archiveMedia` - 500 limit, tag management, filtering, persistent archival |
| commandDeployer.js | `loadCommands/deployCommands/getCachedHash` - Registration utility |

## Components (src/components/)
| Component | Purpose |
|-----------|---------|
| bytepodControls.js | `getControlPanel()`, `getRenameModal()`, `getLimitModal()`. Layout: Row1[Lock,Whitelist,Co-Owner] Row2[Rename,Limit,Kick] |

---

## Events (src/events/)

| Event | Purpose |
|-------|---------|
| ready.js | Once. Init services (Birthday, Auto-Responder, Starboard, Reminder, Activity Streak), BytePod cleanup, Rich Presence rotation |
| interactionCreate.js | Routes autocomplete, BytePod interactions, executes security pipeline, tracks command activity for streaks |
| voiceStateUpdate.js | BytePod create/delete lifecycle, tracks voice activity for streaks |
| guildCreate.js / guildDelete.js | Auto-register/cleanup guilds table |
| guildMemberAdd.js | Welcome message system, 18 variable replacements, embed/plain text modes |
| messageCreate.js | Auto-responder triggers, tracks message activity for streaks |
| messageDelete.js | Mark bookmarks as deleted |
| messageReactionAdd/Remove.js | Suggestion vote counting (pending status only) |

---

## Development Patterns

### Adding Commands
1. Create `src/commands/[category]/name.js`
2. Export: `data` (SlashCommandBuilder), `execute` (async), optional: `cooldown`, `devOnly`, `longRunning`, `permissions`, `autocomplete`
3. Category auto-assigned from folder, auto-registered

### Adding Events
1. Create `src/events/name.js`
2. Export: `name` (Events constant), `execute` (async), optional: `once`
3. Auto-registered

### Database Changes
1. Edit `src/database/schema.js`
2. **CRITICAL:** Update `expectedSchema` in `src/database/index.js` to match (auto-migration won't work without this!)
3. `npm run db:generate` (creates migration file)
4. Start bot - migrations auto-applied via `validateAndFixSchema()` + Drizzle migrate

**Important:** The `expectedSchema` object must stay in sync with `schema.js`. It's used by `validateAndFixSchema()` to auto-add missing columns before Drizzle migrations run. If you add a new field to a table in `schema.js`, you MUST also add it to `expectedSchema` or the column won't be created automatically.

### Testing
`npm test` - branding.test.js (no direct EmbedBuilder), commands.test.js, events.test.js, utils.test.js

### Important Flags
- `MessageFlags.Ephemeral` - New ephemeral pattern
- `command.longRunning` - Auto-defers for API calls
- `command.devOnly` - Restricts to config.developers
- `data.dm_permission = false` - Prevent DM usage

---

## Data Flows

```
Command: User ‚Üí Slash ‚Üí interactionCreate ‚Üí Security(8 steps) ‚Üí execute() ‚Üí branded embed
BytePod Create: Join Hub ‚Üí voiceStateUpdate ‚Üí perm check ‚Üí create channel ‚Üí apply whitelist ‚Üí move user ‚Üí insert DB ‚Üí control panel
BytePod Control: Click ‚Üí interactionCreate ‚Üí handleInteraction() ‚Üí validate ownership ‚Üí execute ‚Üí update perms ‚Üí refresh panel
RBAC: /perm add ‚Üí insert DB | User runs cmd ‚Üí checkUserPermissions() ‚Üí DB overrides? check roles : check code perms
Welcome: User joins ‚Üí guildMemberAdd ‚Üí check enabled+channel ‚Üí parse variables (18 types) ‚Üí send embed/plain ‚Üí error handling (perms/deleted)
```

---

## File Reference

**Core:** index.js(42), commandHandler.js(48), eventHandler.js(23)
**Database:** schema.js(319), index.js(302)
**Events:** interactionCreate.js(375), voiceStateUpdate.js(500+), ready.js(200), guildCreate.js(22), guildDelete.js(19), guildMemberAdd.js(125), messageCreate.js(39)
**Utils:** embeds.js(61), logger.js(15), permissions.js(51), permissionCheck.js(66), wtService.js(101)
**Services:** activityStreakService.js(595), birthdayService.js(353), autoResponderService.js, starboardService.js, reminderService.js, mediaGalleryService.js(200)
**Components:** bytepodControls.js(94)
**Commands:** bytepod.js(394)‚ö†Ô∏èCOMPLEX, perm.js(168), welcome.js(380), media.js(680), help.js(84), streak.js(240)

---

## Gotchas

| Area | Issue |
|------|-------|
| BytePod | Co-owner requires EXPLICIT ManageChannels overwrite, not server Admin |
| BytePod | CustomIds embed panel message ID for targeted updates |
| BytePod | Whitelist intent: If any user lacks Connect, action="add"; else "remove" |
| BytePod | Owner can't be kicked, can't whitelist self, filtered from lists |
| RBAC | DB overrides exist ‚Üí code permissions IGNORED |
| RBAC | Administrator always bypasses |
| Database | **CRITICAL:** Adding columns to schema.js? MUST also update `expectedSchema` in database/index.js or auto-migration fails |
| Errors | 10003 = channel deleted, handle gracefully |
| Errors | Wrap all DMs in try/catch |
| Cooldowns | In-memory only, reset on restart |
| Achievements | Auto-seeds on first run, auto-backfills on every startup |
| Achievements | Achievement cache is 1-hour, invalidate after creating custom achievements |
| Achievements | Seasonal achievements validated on award, not on earn (prevents backdating) |

---

## Config

**.env:** `DISCORD_TOKEN`, `CLIENT_ID`, `GUILD_ID`, `DATABASE_URL` (optional, defaults sqlite.db)

**config.json:**
```json
{
  "developers": ["208026791749746690"],
  "brand": { "name": "ByteBot", "color": "#8A2BE2", "logo": "" },
  "colors": { "primary": "#8A2BE2", "success": "#57F287", "error": "#ED4245", "warning": "#FEE75C", "white": "#FFFFFF" }
}
```

---

## Deployment

**CLI:**
- `npm start -- --deploy` - Force to GUILD_ID
- `npm start -- --deploy-all` - All guilds (instant)
- `npm start -- --deploy-global` - Global (1hr propagation)

**In-Bot:** `/deploy scope:Guild|Global` (owner only)

**Intents:** Guilds, GuildMembers, GuildMessages, MessageContent, GuildVoiceStates, GuildMessageReactions

**Permissions:** Min(SendMessages,EmbedLinks,UseSlashCommands), Mod(BanMembers,KickMembers,ManageMessages,ManageChannels), BytePods(ManageChannels,MoveMembers,Connect)

---

## Recent Changes

### 2025-12-28 - Achievement System Full Implementation
- **COMPLETE:** Full achievement system with auto-initialization, checking, awarding, DM notifications, and role rewards
- **NEW:** `src/data/achievementDefinitions.js` - Centralized achievement data file (103 definitions: 87 core + 16 seasonal)
- **AUTO-SEEDING:** AchievementManager detects empty database and auto-seeds 103 achievements on first `loadDefinitions()` call
- **AUTO-BACKFILL:** `processMissedAchievements()` runs on every bot startup - checks all users and awards missing achievements
- **ACHIEVEMENT CHECKING:** `checkAllAchievements()` evaluates all achievement criteria (streak, total, cumulative, combo, meta) against user stats
- **ACHIEVEMENT AWARDING:** `awardAchievement()` grants achievements, sends DM notifications, creates/assigns roles
- **ELIMINATED SCRIPTS:** Deleted `seed-achievements.js`, `seed-seasonal-events.js`, `backfill-achievements.js` - now obsolete
- **SIMPLIFIED WORKFLOW:** `npm start` ‚Üí Auto-seeds achievements ‚Üí Backfills all users ‚Üí Ready
- **FILES MODIFIED:**
  - `activityStreakService.js` - Implemented `seedAchievements()`, `checkAllAchievements()`, `processMissedAchievements()`
  - `achievementDefinitions.js` - Created with CORE_ACHIEVEMENTS (87), SEASONAL_ACHIEVEMENTS (16), ALL_ACHIEVEMENTS (103)
  - `CLAUDE.md` - Updated documentation to reflect full implementation
- **CURRENT STATUS:** ‚úÖ Fully implemented and ready to use
- **PATTERN ALIGNMENT:** Matches bot architecture where everything auto-initializes (Birthday service, Auto-responder, BytePod cleanup, etc.)

### 2025-12-28 - Achievement System Design & Architecture
- **ARCHITECTURE:** 9 achievement categories (streak, dedication, social, voice, explorer, special, combo, meta, seasonal) with 6 rarity tiers (common ‚Üí mythic)
- **SCOPE:** 87 core achievements + 16 seasonal events + guild custom achievements + role rewards
- **DATABASE:**
  - **New tables (4):** achievementDefinitions, achievementRoleConfig, achievementRoles, customAchievements
  - **Extended tables (2):** activityAchievements (+points, +notified), activityLogs (+7 tracking columns: bytepodsCreated, channelJoins, reactionsAdded, activeHours, etc.)
- **FEATURES:**
  - **Automatic tracking:** 8 metrics tracked daily - messages, voice minutes, commands, BytePods created, channel joins, reactions, active hours
  - **Achievement checking:** 6 check methods (streak, totalDays, cumulative, special, combo, meta) run on daily activity
  - **Role rewards:** Dynamic role creation with rarity-based colors, configurable prefix, automatic cleanup of 0-member roles
  - **Seasonal achievements:** Year-agnostic date matching, 16 events (Halloween, Christmas, Valentine's, Spring, Summer, Fall, New Year)
  - **Custom achievements:** Guild-specific achievements via modal builder, manual award only
  - **DM notifications:** Users receive DM when earning achievements (respects privacy settings)
- **COMPONENTS:**
  - **AchievementManager class:** 1-hour cache, loads definitions from DB, seasonal validation methods (`isSeasonalActive`, `canAward`)
  - **ActivityStreakService:** Enhanced with 8 tracking methods, 6 checking methods, award flow with seasonal validation
  - **Utility helpers:** achievementUtils.js with shared functions (emojis, tiers, progress bars, milestones, formatting)
- **COMMANDS:**
  - `/achievement setup/view/cleanup/list_roles/create/award` - Admin command (Administrator required)
    - `create` - Modal builder for custom achievements (5 fields: title, description, emoji, rarity, points)
    - `award` - Manual award with autocomplete (includes core + custom achievements)
    - `setup` - Configure role rewards (enabled, prefix, rarity colors, cleanup, notifications)
  - `/streak view/leaderboard/achievements/progress` - Enhanced user command
    - `view` - Shows current/longest streak, achievements earned with rarity + points
    - `leaderboard` - 5 types (current streak, longest streak, achievement count, total points, rarest achievement)
    - `achievements` - Browser with filters (category, rarity, earned status) and pagination (5/page with buttons)
    - `progress` - Visual progress bars for next milestones (streak, total days, messages, voice)
  - **Userinfo integration:** Top 6 achievements + total count/points displayed in `/userinfo`
- **DATA:**
  - `src/data/achievementDefinitions.js` - All 103 achievement definitions (87 core + 16 seasonal)
  - **Auto-initialization:** Automatically seeded on first startup if database is empty
  - **Auto-backfill:** Awards missing achievements to all users on every bot restart
  - No manual seeding or backfill scripts required - fully automated
- **TRACKING INTEGRATION:**
  - messageCreate.js - Message count + active hour tracking
  - voiceStateUpdate.js - Voice minutes, channel joins, BytePod creation tracking
  - interactionCreate.js - Command tracking + achievement modal routing
  - messageReactionAdd.js - Reaction tracking
- **AWARD FLOW:** Activity ‚Üí Track ‚Üí Daily check (midnight UTC) ‚Üí Calculate eligible ‚Üí Seasonal validation ‚Üí Award ‚Üí Insert DB ‚Üí DM notification ‚Üí Grant role
- **FILES:**
  - `activityStreakService.js` (~1700 lines) - Core service, AchievementManager, tracking, checking, awarding
  - `achievementUtils.js` (240 lines) - Shared helpers
  - `achievement.js` (525 lines) - Admin command with 6 subcommands + autocomplete
  - `streak.js` (700 lines) - User command with 4 subcommands + pagination
  - `userinfo.js` - Added achievement showcase section
  - `schema.js` - 4 new tables, 2 extended tables
  - `interactionCreate.js` - Achievement modal handling
  - Scripts: seed-achievements.js, seed-seasonal-events.js, backfill-achievements.js
- **KEY FEATURES:**
  - Point system (10-1000 pts) with rarity-based scaling
  - User tier badges (Newcomer ‚Üí Legend) based on total achievements (0-82+)
  - Seasonal window enforcement (prevents backdating/off-season awards)
  - Custom achievement validation (unique titles per guild)
  - Cache invalidation after custom achievement creation
  - Role reward cleanup scheduler (daily at midnight UTC)
  - Graceful error handling (DMs fail silently if user blocks bot)
- **GOTCHAS:**
  - Achievement cache is 1-hour, must invalidate after creating custom achievements
  - Seasonal achievements validated on award, not on earn
  - Role rewards require bot ManageRoles permission
  - Custom achievements have auto-generated IDs: `custom_{guildId}_{sanitized_title}`

### 2025-12-28 - Media Gallery Archive Bug Fixes
- **FIX:** Critical bug where archived media URLs expired when original messages were deleted
- **BUG #1:** Reposted messages were using `attachment.url` (original) instead of `mediaData.mediaUrl` (archived)
  - **IMPACT:** When original messages were deleted, even archived media became inaccessible
  - **FIX:** Updated `buildMediaMessage()` in `mediaGalleryService.js` to use archived URLs from database
  - **AFFECTED:** Video reposts (line 290-291), image embeds (line 326), audio links (line 328)
- **BUG #2:** `markDeleted()` unconditionally marked all URLs as expired, including archived ones
  - **IMPACT:** Archived media (hosted on archive channel messages) incorrectly flagged as expired
  - **FIX:** Updated `markDeleted()` in `mediaUtil.js` to only expire URLs if `archiveMessageId` is null
  - **LOGIC:** Archived media has `archiveMessageId` set ‚Üí URL hosted on archive message ‚Üí remains valid after original deletion
- **RESULT:** Archived media (‚â§25MB) now correctly persists after original message deletion
- **FILES:** `src/services/mediaGalleryService.js` (lines 290-291, 326, 328), `src/utils/mediaUtil.js` (lines 426-449)

### 2025-12-26 - Media Gallery System with Persistent Archive
- **NEW:** Dual-capture media archive system (auto-monitor + manual saves)
- **FEATURES:** Rich metadata (file type, size, dimensions, MIME type), tag system, descriptions, advanced filtering, full-text search
- **ARCHIVE SYSTEM:** All media is automatically archived to a hidden guild channel, ensuring persistence even after original message deletion
  - **Auto-archival:** Downloads and re-uploads all media to guild's `media-archive` channel (hidden from users)
  - **Permanent URLs:** Archived media uses Discord CDN URLs that never expire
  - **Graceful fallback:** If archiving fails, falls back to original URL with warning
  - **Auto-recovery:** If archive channel is deleted, bot recreates it automatically
- **UI/UX:** Button pagination (prev/next), embed thumbnails (list/search), image display (view), real-time stats (page size in MB, item count)
- **COMMANDS:** `/media setup/list/delete/search/view/tag/describe/help` + Save Media context menu
- **DATABASE:**
  - 3 tables: mediaGalleryConfig (channel configs), mediaItems (media storage with urlExpired flag), mediaTags (tag system)
  - Added `mediaArchiveChannelId` to guilds table for per-guild archive channels
- **ARCHITECTURE:**
  - **Service:** MediaGalleryService with 5-min config caching, role whitelist validation, file type/size filtering, automatic archival
  - **Utility:** mediaUtil.js with CRUD operations, pagination, search, tag management, archive channel management
  - **Archive Functions:** `getOrCreateArchiveChannel()`, `archiveMedia()` - handles download/re-upload process
  - **Auto-capture:** Monitors messageCreate for attachments in configured channels
  - **Manual saves:** Right-click message ‚Üí Save Media context menu (100MB limit vs 50MB auto-capture)
  - **Button handler:** interactionCreate.js routes media_ buttons to handleInteraction()
- **LIMITS:** 500 items/user, configurable file types and size limits per channel
- **SECURITY:** ManageChannels permission for setup, ownership verification for all operations, 3s cooldown
- **INTEGRATION:** Hooks into messageCreate.js (auto-capture), messageDelete.js (marks deleted+expired), ready.js (service init), interactionCreate.js (button routing)
- **FILES:** `mediaUtil.js`, `mediaGalleryService.js`, `media.js` (~1000 lines), `save-media.js`, `schema.js`, `ready.js`, `messageCreate.js`, `messageDelete.js`, `interactionCreate.js`
- **SUBCOMMANDS:**
  - `setup` - Configure auto-capture for channels (ManageChannels required) - auto-creates archive channel
  - `list` - Browse gallery with pagination and filters (type, channel)
  - `delete` - Remove media items
  - `search` - Full-text search by description, filename, or message content
  - `view` - Detailed media info with all metadata, tags, and links (shows URL expiration warnings)
  - `tag` - Add comma-separated tags to media items
  - `describe` - Add/update descriptions (max 1000 chars)
  - `help` - Comprehensive user-friendly guide covering all features

### 2025-12-26 - Welcome Message System Fix
- **FIX:** Added missing `GuildMembers` intent required for guildMemberAdd event to fire
- **CRITICAL:** Welcome messages were not working because Discord wasn't sending member join events
- **UPDATED:** Added `GatewayIntentBits.GuildMembers` to client intents in src/index.js
- **DOCS:** Updated CLAUDE.md to reflect all active intents (GuildMembers, GuildMessageReactions)
- **FILES:** `index.js`, `CLAUDE.md`
### 2025-12-26 - Ephemeral Response Enhancement
- **IMPROVEMENT:** Improved bot UX by making appropriate responses ephemeral (only visible to command user)
- **CHANGES:**
  - **Administration commands:** All config confirmations now ephemeral (config, welcome, autorespond, starboard, perm)
  - **Developer tools:** All devOnly commands auto-defer as ephemeral (deploy, unregister, guilds, manageguilds)
  - **Utility commands:** Personal/info commands now ephemeral (help specific command, ping, userinfo slash)
  - **Context menus:** Already ephemeral (avatar, userinfo, copyid) ‚úì
  - **Bookmarks:** Already fully ephemeral ‚úì
  - **Moderation:** Kept public for transparency (ban, kick, warn - accountability)
  - **Fun commands:** Kept public for social value
- **RATIONALE:** Reduces channel clutter, protects privacy, maintains transparency where needed
- **FILES:** `interactionCreate.js` (auto-defer devOnly), all admin/utility command files

### 2025-12-26 - Welcome Message System
- **NEW:** Comprehensive welcome message system for new guild members
- **FEATURES:** 18 variable placeholders (user mentions, server info, join dates, account age, member number)
- **VARIABLES:** User: `{user}` `{username}` `{tag}` `{displayname}` | Server: `{server}` `{memberCount}` `{memberNumber}` | Dates: `{joinedAt}` `{joinedRelative}` `{joinedFull}` `{createdAt}` `{createdRelative}` `{createdFull}` | Account: `{accountAgeDays}` `{accountAgeMonths}`
- **COMMANDS:** `/welcome setup/message/toggle/embed/variables/test/view` - Requires ManageGuild permission (RBAC enforced)
- **UX:** `/welcome variables` shows interactive reference guide with descriptions and examples for all placeholders
- **MODES:** Branded embed (default) or plain text format
- **EVENT:** guildMemberAdd.js - Auto-sends on member join, graceful error handling (perms/deleted channel)
- **DATABASE:** Added `welcomeMessage`, `welcomeEnabled`, `welcomeUseEmbed` to guilds table
- **FILES:** `welcome.js`, `guildMemberAdd.js`, `schema.js`, `index.js`, `config.js`

### 2025-12-26 - Duplicate Command Name Fix
- **FIX:** Resolved Discord API error 50035 (APPLICATION_COMMANDS_DUPLICATE_NAME) caused by two commands named "clear"
- **BREAKING:** Renamed `/clear` developer command to `/unregister` to avoid conflict with moderation `/clear`
- **Commands:** Developer command for clearing registrations is now `/unregister <scope>`
- **Files:** Renamed `clear.js` to `unregister.js` in `src/commands/developer/`

### 2025-12-25 - Activity Streak Tracking
- **NEW:** Daily engagement tracking system with streaks, achievements, and leaderboards
- **Features:** Auto-tracks messages/voice/commands, 11 achievements (3-365 day milestones), monthly streak freeze (save 1 missed day/month)
- **Commands:** `/streak view [@user]`, `/streak leaderboard [current|longest]`
- **Tables:** activityStreaks (current/longest/total days, freeze system), activityAchievements (milestone rewards), activityLogs (daily activity breakdown)
- **Service:** activityStreakService.js - Daily midnight checks, auto-break/freeze logic, achievement DM notifications
- **Tracking:** messageCreate.js (messages), interactionCreate.js (commands), voiceStateUpdate.js (voice minutes)
- **Files:** `activityStreakService.js`, `streak.js`, `schema.js`, `index.js`, `ready.js`, `messageCreate.js`, `interactionCreate.js`, `voiceStateUpdate.js`
- **NEW:** `/unregister <scope>` command to remove duplicate command registrations
- **ENHANCEMENT:** `/deploy` now detects and prevents duplicate registrations
- **NEW:** `checkExistingRegistrations()` utility in `commandDeployer.js`
- **FEATURE:** Auto-detection warns users when both global and guild commands exist
- **FIX:** Prevents creating duplicates by blocking deployment when duplicates detected
- **FILES:** `unregister.js`, `commandDeployer.js`, `deploy.js`
- **DOCS:** Added `DUPLICATE_COMMANDS_FIX.md` comprehensive fix guide

### 2025-12-24 - War Thunder Command Timeout Fix
- **FIX:** `/warthunder` exceeding 3s timeout. Added `longRunning: true`, removed manual deferrals. Both subcommands use `editReply()`.
- **Files:** `src/commands/games/warthunder.js`

### 2025-12-24 - Suggestion System UX
- **FIX:** Redundant emojis in DM/admin embeds
- **ENHANCEMENT:** Ephemeral admin responses (manual deferReply)
- **FIX:** Vote counting locked after review (status check in reaction events)
- **Files:** `suggestion.js`, `messageReactionAdd.js`, `messageReactionRemove.js`

### 2025-12-24 - Manual Command Deployment
- **NEW:** `/deploy <scope>` command, `--deploy`/`--deploy-all`/`--deploy-global` CLI flags
- **NEW:** `commandDeployer.js` utility with hash caching
- **Files:** `commandDeployer.js`, `deploy.js`, `commandHandler.js`

### 2025-12-24 - Suggestion System
- **NEW:** `/suggest <idea> [anonymous]` user command, `/suggestion` admin management
- **Features:** Lifecycle (pending‚Üíapproved/denied/implemented), voting, DM notifications, leaderboard
- **Tables:** suggestion_config, suggestions
- **Files:** `suggest.js`, `suggestion.js`, `schema.js`, `index.js`

### 2025-12-23 - Voice State Bug Fix
- **FIX:** Spurious join/leave on mute/camera/screenshare. Added `oldState.channelId !== newState.channelId` check.
- **Files:** `voiceStateUpdate.js` lines 264, 359

### 2025-12-23 - Panel Update Error Handling
- **FIX:** Error 10008 on panel updates. Added `.catch()` to `msg.edit()` in `updatePanel()` (line 575). Best-effort updates.
- **Files:** `bytepod.js`

### 2025-12-22 - Test Suite Cleanup
- **FIX:** Async cleanup issues. Added cleanup methods to services, proper `afterEach` hooks.
- **Files:** `autoResponderService.js`, `starboard.test.js`, `reminder.test.js`, `autoResponder.test.js`

### 2025-12-22 - Auto-Responder System
- **NEW:** Keyword-based responses. Match types: exact/contains/wildcard/regex(dev-only). 50/guild limit, 5-min cache.
- **Commands:** `/autorespond add/remove/list/toggle/edit`
- **Files:** `autoResponderService.js`, `messageCreate.js`, `autorespond.js`, `schema.js`

### 2025-12-22 - Birthday Tracker
- **NEW:** Privacy-focused (no year), daily announcements, 24hr role, leap year handling.
- **Commands:** `/birthday set/remove/view/upcoming/setup/role`
- **Files:** `birthdayService.js`, `birthday.js`, `schema.js`, `ready.js`

### 2025-12-22 - User Context Menus
- **NEW:** 6 menus - Avatar, User Info, Copy ID, Permissions, Activity, Moderate User
- **Moderate User:** Warn/Kick/Ban/History buttons, modal input, hierarchy validation
- **Files:** `avatar.js`, `userinfo.js`, `copyid.js`, `permissions.js`, `activity.js`, `modactions.js`, `interactionCreate.js`

### 2025-12-22 - Message Bookmarks & Context Menus
- **NEW ARCH:** Context menu system with full security pipeline
- **NEW:** Bookmark messages (100 limit, 4000 char, duplicate prevention)
- **Commands:** `/bookmark list/search/view/delete/clear`
- **Files:** `bookmarkUtil.js`, context-menus/`bookmark.js`, `bookmark.js`, `messageDelete.js`, `schema.js`, `index.js`, `commandHandler.js`, `interactionCreate.js`

### 2025-12-20 - Leaderboard, Stats, Cleanup
- **NEW:** `/bytepod leaderboard`, `/stats server`, startup cleanup (empty/orphaned pods)
- **Files:** `stats.js`, `bytepod.js`, `ready.js`

### 2025-12-20 - Guild Management
- **NEW:** `/manageguilds` - List/leave guilds via select menu (devOnly)
- **Files:** `manageguilds.js`

### 2025-12-20 - Ownership Reclaim Fixes
- **Voice Reconnect Bug:** Voice reconnect on button click (replaced `deferUpdate` with ephemeral reply)
- **Duplicate Reclaim Prompts:** Prevents duplicate reclaim prompts (added `reclaimRequestPending` flag)
- **originalOwnerId Backfill:** Auto-backfill `originalOwnerId` for old pods
- **Files:** `schema.js`, `index.js`, `voiceStateUpdate.js`, `bytepod.js`

### 2025-12-20 - Ownership Transfer System
- **NEW:** 5-min grace period, ownership transfer, reclaim flow
- **NEW:** `logger.errorContext()` for detailed debugging
- **NEW:** Auto-schema validation (`validateAndFixSchema()`)
- **Files:** `schema.js`, `voiceStateUpdate.js`, `bytepod.js`, `logger.js`, `interactionCreate.js`, `index.js`

### 2025-12-19 - Voice Stats, Templates, Audit
- **NEW:** Voice activity tracking (persistent sessions), `/bytepod stats/template`, `/audit user/recent/by`
- **Tables:** bytepodActiveSessions, bytepodVoiceStats, bytepodTemplates
- **Files:** `schema.js`, `voiceStateUpdate.js`, `ready.js`, `bytepod.js`, `audit.js`

### 2025-12-19 - Timeout Prevention
- **FIX:** `DiscordAPIError[10062]` across all BytePod ops. Added `deferReply()` before async, changed to `editReply()`.
- **Files:** `bytepod.js`

### 2025-01-XX - Initial Documentation
- Created CLAUDE.md with architecture, flows, patterns, gotchas

---

## Agent Instructions

**WHEN CHANGING:**
1. Update "Recent Changes" with date
2. Update technical sections if modifying: DB schema, security pipeline, commands, data flows
3. Add new patterns to conventions
4. Document new gotchas
5. Keep line numbers current

**BEFORE CHANGING:**
1. Read relevant sections first
2. Follow established patterns
3. Don't break security pipeline
4. Use embeds.js (never raw EmbedBuilder)

**This is your knowledge base. Keep it accurate.**
